<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>

<body>
  <input type="file" name="file" id="file">
  <div id="loading" style="display: none;">loading...</div>
  <script>
    const file = document.getElementById('file');
    file.addEventListener('change', async (e) => {
      /**
       * @type {File}
       */
      const file = e.target.files[0]
      if (file) {
        document.getElementById('loading').style.display = 'block'
        console.log(file)
        const slices = getSlice(file)
        console.log(slices)
        for (const [idx, part] of slices.entries()) {
          await upload(part, slices.length, idx, file.name)
        }
        document.getElementById('loading').style.display = 'none'
      }
    })

    /**
     * @param {File} file
     * @param {number} SliceSize
     */
    function getSlice(file, sliceSize = 100 * 1024 * 1024) {
      const arr = [];
      let i = 0;
      while (i * sliceSize < file.size) {
        arr.push(file.slice(i * sliceSize, (i + 1) * sliceSize))
        i++
      }
      return arr
    }

    function upload(fileOrSlice, total, idx, name) {
      return new Promise((resolve, reject) => {
        const formData = new FormData()
        formData.append('name', name)
        formData.append('idx', idx)
        formData.append('total', total)
        formData.append('file', fileOrSlice)
        return fetch('/upload', {
          method: 'POST',
          body: formData
        }).then(res => {
          resolve(res)
        }, reject)
        reader.readAsArrayBuffer(slice)
      })
    }
  </script>
</body>

</html>